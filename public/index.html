<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
		body {
			font-family: 'Inter', sans-serif;
			background-color: fff;
			color: #333;
      margin: 0;
      height: 100svh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent body scroll */
		}
    label {
      font-weight: bold;

      span {font-weight: normal;}
    }
    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.3);
    }

    #wrapper {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden; /* Prevent wrapper scroll */
    }

    #sidebar {
      background: #f1f0e9;
      padding: 0 20px 20px;
      /* border-right: 1px solid rgb(223, 221, 210); */
      width: 308px;
      overflow-y: auto; /* Allow sidebar to scroll if content is too tall */
      flex-shrink: 0;
    }

    header {
      padding: 14px 0;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;

      h1 {
        color: #454545;
        margin: 0;
        font-size: 16px;
        text-shadow: 1px 1px 1px rgba(255, 255, 255, 1);
        font-weight: 900;

      }
      span {
        font-family: Georgia, 'Times New Roman', Times, serif;
        font-style: italic;
        font-weight: normal;
        font-size: 0.9em;
      }
    }

    #optionsContainer {
      font-size: 0.85em;

      .input-group {
        margin-bottom: 12px;
        padding: 10px;
        background-color: #fcfcfc;
        border-radius: 8px;

        h4 {
          margin-top: 0;
          margin-bottom: 0.75em;
          font-size: 0.76rem;
          text-transform: uppercase;
          color: #999;
          letter-spacing: 0.05em;
        }
      }

      .salesperson-checkboxes {
        /* margin-left: 20px; */
        margin-top: 10px;
        display: none;
        
        p {
          margin: 5px 0;
          padding-left: 50%;
          /* font-size: 0.9em; */

          &:first-child {
            padding-left: 44%;
          }
        }
        
        input[type="checkbox"] {
          transform: scale(1.3);
        }
      }

      .calendar-container {
        margin-bottom: 20px;
      }
      
      .calendar-label {
        font-weight: bold;
        margin-bottom: 8px;
        display: block;
        font-size: 14px;
      }
      
      .flatpickr-calendar {
        margin: 0 auto;
        /* box-shadow: 0 2px 8px rgba(0,0,0,0.15); */
        box-shadow: 0 2px 4px inset rgba(0,0,0,0.3);
        border-radius: 6px;
        font-size: 13px;
        transform: scale(1.85);
        transform-origin: center top;
      }

      /* .flatpickr-months { padding-top: 30px; } */
      /* .flatpickr-innerContainer { padding: 0 30px 30px; } */
      .flatpickr-weekdays { height: 18px !important; }
      .flatpickr-day {
        height: 34px !important;
        line-height: 32px;
      }

      .flatpickr-calendar.inline {
        position: relative;
        display: block;
      }

      /* Trying to fix size */
      /* .flatpickr-months { padding-top: 30px; } */
      /* .flatpickr-innerContainer { padding: 0 30px 30px; } */
      /* .flatpickr-weekdays { height: 18px !important; } */
      /* .flatpickr-day { height: 35px !important; } */


      label {
        margin-right: 5px;
        flex: 1;
      }
      select {
        flex: 1.4;
      }
      p {
        margin: 10px 0 2px 0;
        display: flex;
        align-items: center;
        &:first-child {
          margin-top: 0;
        }
      }
    }

    #outputContainer {
      flex: 1;
      display: flex;
      min-height: 0;
      box-sizing: border-box;
      flex-direction: column;
      overflow: hidden; /* Prevent container scroll */
      background-color: #f1f0e9;;
    }

    .output {
      flex: 1 1 0;
      min-height: 100px;
      font-family: monospace;
      box-sizing: border-box;
      padding: 20px;
      border: none;
      resize: none;
      font-size: 0.95em;
      overflow: auto;
      color: #222;
      border-radius: 8px;
      box-shadow: 0 2px 4px inset rgba(0,0,0,0.3);
      &:focus {
        outline: none;
      }
    }

    #renderedMarkdown {
      flex: 1 1 0;
      min-height: 100px;
      box-sizing: border-box;
      padding: 12px 20px 20px;
      border: none;
      font-size: 0.9em;
      background-color: white;
      overflow: auto;
      color: #222;
      border-radius: 8px;
      box-shadow: 0 2px 4px inset rgba(0,0,0,0.3);
      
      h1, h2, h3 {
        margin-top: 0;
        font-size: 1.25em;
      }
      p {
        margin: 0;
        padding: 2px 0;
        line-height: 1.75;
        color: #999;
      }
      code {
        padding: 1px 4px;
        background-color: rgb(204, 216, 201);
        border: 1px solid rgb(81, 145, 63);
        border-radius: 3px;
        color: rgb(22, 75, 7);
      }
      code + code {
        background-color: rgb(211, 220, 228);
        border: 1px solid rgb(63, 111, 145);
        color: rgb(25, 62, 87);
      }
      a {
        color: rgb(22, 75, 7);
        text-decoration: none;
        &:hover {
          border-bottom: 2px solid rgb(22, 75, 7);
        }
        strong {
          font-weight: 900;
        }
      }
    }

    select {
      font-size: 13px;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #aaa;
      width: 100%;
    }
    
    @media (max-width: 768px) {
      body {
        overflow-x: hidden; /* Prevent horizontal scroll */
      }

      #wrapper {
        position: relative;
        width: 200vw; /* Two panels side by side */
        display: flex;
        flex-direction: row; /* Side by side, not column */
        transition: transform 0.3s ease-in-out;
        min-height: 100svh;
      }

      #wrapper.show-output {
        transform: translateX(-100vw); /* Slide left to show output */
      }
      
      #sidebar {
        width: 100vw;
        height: 100svh;
        max-width: none;
        border-right: none;
        border-bottom: none;
        padding: 0px 10px 68px 10px;
        box-sizing: border-box;
        flex-shrink: 0;
        position: relative;
        
        /* CRITICAL MOBILE SCROLLING FIXES */
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch; /* iOS momentum scrolling */
        touch-action: pan-y; /* Allow vertical touch scrolling only */
        overscroll-behavior-y: contain; /* Prevent bounce affecting parent */
      }
      
      #outputContainer {
        width: 100vw;
        height: 100svh;
        flex-direction: column;
        max-height: none;
        padding: 0;
        gap: 0;
        flex-shrink: 0;
        position: relative;
        
        /* Allow scrollable children but don't scroll container itself */
        overflow: visible;
      }
      
      /* CRITICAL FIX: Make both textarea and rendered markdown scrollable */
      textarea.output, #renderedMarkdown {
        width: 100% !important;
        min-height: 200px !important;
        border-radius: 0 !important;
        
        /* Calculate proper height accounting for button bar */
        height: calc(100svh - 50px) !important; /* 50px for button bar */
        max-height: calc(100svh - 50px) !important;
        padding-bottom: 70px;
        /* CRITICAL MOBILE SCROLLING FIXES */
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important; /* iOS momentum scrolling */
        touch-action: pan-y !important; /* Allow vertical touch scrolling only */
        overscroll-behavior-y: contain !important; /* Prevent bounce affecting parent */
        -webkit-transform: translate3d(0, 0, 0) !important; /* Hardware acceleration */
        
        /* Ensure they can actually scroll */
        flex: none !important; /* Don't use flex sizing on mobile */
      }

      /* Navigation buttons */
      .mobile-nav-button {
        position: fixed;
        bottom: 20px;
        background: #388523;
        color: white;
        border: 1px solid #2a6619;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        transition: all 0.2s ease;
        
        /* Ensure buttons don't interfere with scrolling */
        touch-action: manipulation;
      }

      .mobile-nav-button:hover {
        background: #2a6619;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      }

      .mobile-nav-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }

      #viewListBtn {
        right: 20px;
      }

      #optionsBtn {
        left: 20px;
        display: none;
      }

      #wrapper.show-output #viewListBtn {
        display: none;
      }

      #wrapper.show-output #optionsBtn {
        display: block;
      }

      /* Hide refresh button on mobile */
      #refreshDataBtn {
        display: none;
      }
    }
    
    /* Desktop styles remain unchanged */
    @media (min-width: 769px) {
      #wrapper {
        flex-direction: row;
        height: 100svh; /* Ensure full height */
      }
      
      #optionsContainer {
        max-width: 100%;
        margin-right: 0;
        margin-bottom: 20px;
      }
      
      #outputContainer {
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 0 10px 0 0;
        gap: 0;
        box-sizing: border-box;
        flex: 1;
        overflow: hidden;
      }
      
      /* Ensure both editing + preview panes flex properly and only they scroll */
      #markdown-output,
      #renderedMarkdown {
        flex: 1;
        min-height: 0;
        overflow: auto;
      }

      .mobile-nav-button {
        display: none !important;
      }
    }

    /* Button styles */
    .button-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      padding: 10px 0px 10px 0;
      gap: 10px; /* add gap so copy selector just sits beside preview */
      background: #f1f0e9;
      
      /* On mobile, ensure button bar doesn't interfere with scrolling */
      flex-shrink: 0;
      height: 30px; /* Fixed height for calculations */
    }

    .button {
      background: #f1f0e9;
      border: 1px solid #bbb;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      /* gap: 8px; */
      align-items: center;
      justify-content: center;
    }

    .button.active {
      background-color: rgb(56, 133, 35);
      color: #fff;
      border: 1px solid #aaa;
      /* box-shadow: inset 0 0 5px rgb(30, 91, 14); */
    }

    .preview-button {
      border: none !important;
      padding: 0 !important;
      margin-left: auto;
      -webkit-mask: url('./markdown-mark.svg') no-repeat center/contain;
      mask: url('./markdown-mark.svg') no-repeat center/contain;
      background-color: rgb(56, 133, 35);
      text-indent: -9999px;
      height: 32px;
      width: 32px;
      border-radius: 0;
      aspect-ratio: auto;
       
      &.active {
        background-color: #666;
      }
    }    

    /* Custom dropdown styles */
    .copy-dropdown-container {
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .copy-dropdown-trigger {
      background: #f1f0e9;
      border: 1px solid #bbb;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      min-width: 120px;
      text-align: left;
    }

    .copy-dropdown-trigger:hover {
      background: #e0dfd6;
    }

    .copy-dropdown-trigger:after {
      content: '‚ñº';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #666;
    }

    .copy-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #bbb;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .copy-dropdown-menu.show {
      display: flex;
    }

    .copy-dropdown-item {
      background: none;
      border: none;
      padding: 8px 12px;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.1s;
    }

    .copy-dropdown-item:hover {
      background: #f0f0f0;
    }

    .copy-dropdown-item:first-child {
      border-radius: 4px 4px 0 0;
    }

    .copy-dropdown-item:last-child {
      border-radius: 0 0 4px 4px;
    }

    .filter-input {
      flex: 1;
      max-width: 200px;
      padding: 6px 12px;
      border: 1px solid #bbb;
      border-radius: 8px;
      font-size: 13px;
      background: white;
      transition: border-color 0.2s;
    }

    .filter-input:focus {
      outline: none;
      border-color: #388523;
      box-shadow: 0 0 0 2px rgba(56, 133, 35, 0.2);
    }

    .filter-input::placeholder {
      color: #999;
    }

    .copied-indicator {
      order: 2;
      font-size: 13px;
      font-weight: bold;
      color: #388523;
      pointer-events: none;
      white-space: nowrap;
      opacity: 0;
      margin-left: 6px;
    }

    @media (max-width: 768px) {
      .copied-indicator { order: 1; margin-left: 0; margin-right: 6px; }
      .copy-dropdown { order: 2; }
      .button-bar {
        justify-content: space-between; /* push ends apart on mobile */
        padding-left: 10px;
			}
      .copy-dropdown-container {
        margin-left: auto; /* ensures it hugs right even if spacing rules change */
      }
    }

    /* Calendar stuff */
    .flatpickr-calendar.arrowTop:before,
    .flatpickr-calendar.arrowTop:after {display: none;}
    .flatpickr-monthDropdown-months, .numInput {
      font-size: 16px !important;
    }

    .flatpickr-day.selected,
    .flatpickr-day.selected.startRange,
    .flatpickr-day.selected.endRange,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange,
    .flatpickr-day.startRange:hover,
    .flatpickr-day.endRange:hover {
      background: rgb(56, 133, 35) !important;
      color: #fff;
      font-weight: bold;
      border-color: rgb(56, 133, 35) !important;
    }
    .flatpickr-day.inRange {
      background: rgb(138, 198, 121) !important;
      border-width: 1px!important;
      border-style: solid!important;
      border-color: rgb(138, 198, 121)!important;
      color: rgb(56, 133, 35)!important;
      -webkit-box-shadow: -5px 0 0 rgb(138, 198, 121),5px 0 0 rgb(138, 198, 121)!important;
      box-shadow: -5px 0 0 rgb(138, 198, 121),5px 0 0 rgb(138, 198, 121)!important;
    }
    .flatpickr-day.today {
      border-color: rgb(56, 133, 35);
      border-width: 2px;
      border-style: dotted;
    }
    .flatpickr-day.inRange.today {
      background: rgb(138, 198, 121);
      border-color: rgb(56, 133, 35);
      border-width: 2px;
      border-style: dotted;
    }
    .flatpickr-day.selected.startRange + .endRange:not(:nth-child(7n+1)), 
    .flatpickr-day.startRange.startRange + .endRange:not(:nth-child(7n+1)), 
    .flatpickr-day.endRange.startRange + .endRange:not(:nth-child(7n+1)) {
      box-shadow: -10px 0 0 rgb(138, 198, 121);
    }

    /* Refresh button styles */
    #refreshDataBtn {
      background: #388523;
      color: white;
      border: 1px solid #2a6619;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }

    #refreshDataBtn:hover {
      background: #2a6619;
    }

    #refreshDataBtn:disabled {
      background: #666;
      cursor: not-allowed;
    }
  </style>
  <script>
    // Pre-authentication: On page load, check if the user is authenticated.
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/authenticated', { headers: { 'Accept': 'application/json' } });
        if (!response.ok) {
          throw new Error('Not authenticated');
        }
        console.log('User is authenticated');
      } catch (error) {
        console.log('Not authenticated, redirecting to login...');
        window.location.href = '/auth/jobber';
        return;
      }

      // Compute the next Sunday (if today is Sunday, use next Sunday, not today).
      function getNextSunday() {
        const now = new Date();
        const day = now.getDay(); // Sunday = 0, Monday = 1, ..., Saturday = 6
        let daysUntilSunday = (7 - day) % 7;
        if (daysUntilSunday === 0) daysUntilSunday = 7; // If today is Sunday, get next Sunday
        const nextSunday = new Date(now);
        nextSunday.setDate(now.getDate() + daysUntilSunday);
        // Set time to beginning of day
        nextSunday.setHours(0, 0, 0, 0);
        return nextSunday;
      }

      // Compute the Friday following the given Sunday.
      function getFollowingFriday(fromSunday) {
        const friday = new Date(fromSunday);
        friday.setDate(fromSunday.getDate() + 5); // Friday is 5 days after Sunday
        // Set time to end of day
        friday.setHours(23, 59, 59, 999);
        return friday;
      }

      // Load settings first to check for saved dates
      const settings = loadSettings();
      
      let defaultStartDate, defaultEndDate;
      
      if (settings.startDate && settings.endDate) {
        // Use saved dates if they exist
        defaultStartDate = new Date(settings.startDate);
        defaultEndDate = new Date(settings.endDate);
        console.log('Using saved dates from localStorage:', { defaultStartDate, defaultEndDate });
      } else {
        // Use default Sunday-Friday range
        defaultStartDate = getNextSunday();
        defaultEndDate = getFollowingFriday(defaultStartDate);
        console.log('Using default Sunday-Friday dates:', { defaultStartDate, defaultEndDate });
      }
      
      // Set global variables before initializing calendar
      STARTDATE = defaultStartDate;
      ENDDATE = defaultEndDate;

      console.log('Initial dates:', { STARTDATE, ENDDATE });

      // Initialize single Flatpickr calendar with range selection
      const dateRangePicker = flatpickr("#dateRangeCalendar", {
        inline: true,
        mode: "range",
        defaultDate: [defaultStartDate, defaultEndDate],
        onChange: function(selectedDates, dateStr, instance) {
          console.log('Calendar onChange triggered:', selectedDates);
          if (selectedDates.length === 2) {
            // Ensure start date is at beginning of day and end date is at end of day
            STARTDATE = new Date(selectedDates[0]);
            STARTDATE.setHours(0, 0, 0, 0);
            
            ENDDATE = new Date(selectedDates[1]);
            ENDDATE.setHours(23, 59, 59, 999);
            
            console.log('Updated dates from calendar:', { STARTDATE, ENDDATE });
            saveSettings(); // Save dates when they change
            fetchVisits();
          }
        }
      });

      // Apply other settings
      applySettings(settings);
      
      // Add a small delay to ensure calendar is fully initialized
      setTimeout(() => {
        console.log('About to fetch with dates:', { STARTDATE, ENDDATE });
        fetchVisits();
      }, 100);
    });
  </script>

  <title>Jobber Visits To Markdown</title>
</head>
<body>
  <div id="wrapper">
    <div id="sidebar">
      <header>
        <h1>QuickList</h1>
        <span>for Jobber</span>
      </header>
  
      <div id="optionsContainer">
        <div class="calendar-container">
          <!-- <label class="calendar-label">Select Date Range:</label> -->
          <div id="dateRangeCalendar"></div>
        </div>

        <div class="input-group">
          <h4>Display</h4>
          <p><input type="checkbox" id="showDatesCheckbox"><label for="showDatesCheckbox">Dates</label></p>
          <div id="dateOptionsContainer" class="date-options" style="display: none; margin-left: 20px; margin-top: 10px;">
            <p>
              <input type="radio" id="showDatesAll" name="dateDisplay" value="all">
              <label for="showDatesAll">All Dates</label>
            </p>
            <p>
              <input type="radio" id="showDatesWeekdayOnly" name="dateDisplay" value="weekdayOnly">
              <label for="showDatesWeekdayOnly">Only Weekdays</label>
            </p>
          </div>
          <p><input type="checkbox" id="showTimeCheckbox"><label for="showTimeCheckbox">Times</label></p>
          <p><input type="checkbox" id="showValueCheckbox"><label for="showValueCheckbox">$ Value</label></p>
          <p><input type="checkbox" id="showSalespersonCheckbox"><label for="showSalespersonCheckbox">Salesperson</label></p>
          <p><input type="checkbox" id="showRangeInfoCheckbox" checked><label for="showRangeInfoCheckbox">Range Summary</label></p>
        </div>

        <div class="input-group">
          <!-- <h4>Sorting</h4> -->
          <p>
            <label for="sortBySelect">Sort by:</label>
            <select id="sortBySelect">
              <option value="date">Date</option>
              <option value="alphabetical">Alphabetical</option>
              <option value="value">$ Value</option>
              <option value="geoCode">GeoCode</option>
              <option value="geoCodeThenValue">GeoCode, then $ Value</option>
              <option value="salesperson">Salesperson</option>
            </select>
          </p>
        </div>
  
        <div class="input-group">
          <h4>Visibility</h4>
          <p>
            <label for="annualSelect">Annual Jobs:</label>
            <select id="annualSelect">
              <option value="include" selected>Include Annual Jobs</option>
              <option value="exclude">Exclude Annual Jobs</option>
              <option value="excludeUnconfirmed">Exclude Unconfirmed Annual Jobs</option>
              <option value="annualOnly">Show Only Annual Jobs</option>
              <option value="annualOnlyConfirmed">Show Only *Confirmed* Annual Jobs</option>
              <option value="annualOnlyUnconfirmed">Show Only *Unconfirmed* Annual Jobs</option>
            </select>
          </p>
          <p>
            <label for="salespersonFilterSelect">Salesperson:</label>
            <select id="salespersonFilterSelect">
              <option value="all" selected>Include All</option>
              <option value="showSelected">Include Selected...</option>
            </select>
          </p>
          <div id="salespersonCheckboxes" class="salesperson-checkboxes">
            <!-- Dynamic checkboxes will be populated here -->
          </div>
        </div>
  
        <p>
          <button id="refreshDataBtn" class="button active">Refresh Data</button>
        </p>
      </div>

      
    </div>

    <div id="outputContainer">
      <div class="button-bar">
        <input type="text" id="filterInput" placeholder="Filter jobs..." class="filter-input">
        <button id="previewMarkdownBtn" class="preview-button button" title="Preview Markdown">M</button>
        <div class="copy-dropdown-container">
          <button class="copy-dropdown-trigger" id="copyDropdownTrigger">Copy List as...</button>
          <div class="copy-dropdown-menu" id="copyDropdownMenu">
            <button class="copy-dropdown-item" data-copy-type="markdown">Markdown</button>
            <button class="copy-dropdown-item" data-copy-type="richtext">Rich Text</button>
            <button class="copy-dropdown-item" data-copy-type="plaintext">Plain Text</button>
          </div>
        </div>
      </div>
      <textarea id="markdown-output" class="output" placeholder="Your Markdown will go here."></textarea>
      <div id="renderedMarkdown" style="display:none;"></div>
    </div>
  </div>

  <!-- Mobile navigation buttons -->
  <button id="viewListBtn" class="mobile-nav-button">View List üëâüèº</button>
  <button id="optionsBtn" class="mobile-nav-button">üëàüèº Options</button>

  <script>
    let DATA = null;
    let STARTDATE = null;
    let ENDDATE = null;

    const DEFAULT_SETTINGS = {
      sortBy: "date",
      annual: "include",
      showDates: false,
      dateDisplayType: "all",
      showValue: false,
      showSalesperson: true,
      showRangeInfo: true,
      showTime: false,
      startDate: null,
      endDate: null,
      salespersonFilter: "all",
      selectedSalespeople: []
    };

    // Function to save current settings to localStorage
    function saveSettings() {
      const selectedSalespeople = [];
      document.querySelectorAll('.salesperson-checkbox:checked').forEach(checkbox => {
        selectedSalespeople.push(checkbox.value);
      });

      const showDatesCheckbox = document.getElementById('showDatesCheckbox');
      const selectedDateType = document.querySelector('input[name="dateDisplay"]:checked');

      const currentSettings = {
        sortBy: sortBySelect.value,
        annual: annualSelect.value,
        showDates: showDatesCheckbox.checked,
        dateDisplayType: selectedDateType ? selectedDateType.value : 'weekdayOnly',
        showValue: showValueCheckbox.checked,
        showSalesperson: showSalespersonCheckbox.checked,
        showRangeInfo: showRangeInfoCheckbox.checked,
        showTime: showTimeCheckbox.checked,
        startDate: STARTDATE ? STARTDATE.toISOString() : null,
        endDate: ENDDATE ? ENDDATE.toISOString() : null,
        salespersonFilter: document.getElementById('salespersonFilterSelect').value,
        selectedSalespeople: selectedSalespeople
      };
      
      localStorage.setItem('jobberSettings', JSON.stringify(currentSettings));
      console.log('Settings saved:', currentSettings);
    }

    // Function to load settings from localStorage
    function loadSettings() {
      try {
        const savedSettings = localStorage.getItem('jobberSettings');
        if (savedSettings) {
          return JSON.parse(savedSettings);
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
      return DEFAULT_SETTINGS; // Return defaults if nothing saved or error
    }

    // Function to apply settings to form elements
    function applySettings(settings) {
      sortBySelect.value = settings.sortBy;
      annualSelect.value = settings.annual;
      
      // Handle new checkbox/radio structure
      const showDatesCheckbox = document.getElementById('showDatesCheckbox');
      showDatesCheckbox.checked = settings.showDates;
      
      // Set the radio button based on dateDisplayType
      const dateRadio = document.querySelector(`input[name="dateDisplay"][value="${settings.dateDisplayType}"]`);
      if (dateRadio) {
        dateRadio.checked = true;
      }
      
      // Show/hide date options based on checkbox state
      toggleDateOptions();
      
      showValueCheckbox.checked = settings.showValue;
      showSalespersonCheckbox.checked = settings.showSalesperson;
      showRangeInfoCheckbox.checked = settings.showRangeInfo;
      showTimeCheckbox.checked = settings.showTime;
      
      if (settings.salespersonFilter) {
        document.getElementById('salespersonFilterSelect').value = settings.salespersonFilter;
      }
    }

    // Function to toggle date options visibility
    function toggleDateOptions() {
      const showDatesCheckbox = document.getElementById('showDatesCheckbox');
      const dateOptionsContainer = document.getElementById('dateOptionsContainer');
      
      if (showDatesCheckbox.checked) {
        dateOptionsContainer.style.display = 'block';
        
        // If no radio button is currently selected, default to "all"
        const selectedRadio = document.querySelector('input[name="dateDisplay"]:checked');
        if (!selectedRadio) {
          const allRadio = document.getElementById('showDatesAll');
          if (allRadio) {
            allRadio.checked = true;
          }
        }
      } else {
        dateOptionsContainer.style.display = 'none';
      }
    }

    // Function to get current date display setting
    function getDateDisplaySetting() {
      const showDatesCheckbox = document.getElementById('showDatesCheckbox');
      
      if (!showDatesCheckbox.checked) {
        return 'none';
      }
      
      const selectedRadio = document.querySelector('input[name="dateDisplay"]:checked');
      return selectedRadio ? selectedRadio.value : 'weekdayOnly';
    }

    // Function to extract unique salespeople from data
    function extractSalespeople(data) {
      const salespeople = new Set();
      if (data && data.data && data.data.visits && data.data.visits.edges) {
        data.data.visits.edges.forEach(edge => {
          const salespersonName = edge.node.job.salesperson ? edge.node.job.salesperson.name.first.trim() : 'Unknown';
          salespeople.add(salespersonName);
        });
      }
      return Array.from(salespeople).sort();
    }

    // Function to populate salesperson checkboxes
    function populateSalespersonCheckboxes(data) {
      const container = document.getElementById('salespersonCheckboxes');
      const salespeople = extractSalespeople(data);
      const settings = loadSettings();
      
      container.innerHTML = '';
      
      // Add "All" checkbox at the top
      const allP = document.createElement('p');
      const allCheckbox = document.createElement('input');
      allCheckbox.type = 'checkbox';
      allCheckbox.className = 'salesperson-all-checkbox';
      allCheckbox.id = 'salesperson_all';
      allCheckbox.checked = true; // Default to checked
      
      allCheckbox.addEventListener('change', () => {
        const isChecked = allCheckbox.checked;
        // Update all individual checkboxes
        document.querySelectorAll('.salesperson-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        formatAndDisplay();
        saveSettings();
      });
      
      const allLabel = document.createElement('label');
      allLabel.htmlFor = 'salesperson_all';
      allLabel.textContent = 'Select All:';
      allLabel.style.fontWeight = 'bold';
      
      allP.appendChild(allCheckbox);
      allP.appendChild(allLabel);
      container.appendChild(allP);
      
      // Add individual salesperson checkboxes
      salespeople.forEach(salesperson => {
        const p = document.createElement('p');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'salesperson-checkbox';
        checkbox.value = salesperson;
        checkbox.id = `salesperson_${salesperson.replace(/[^a-zA-Z0-9]/g, '_')}`;
        
        // Restore saved selections, or default to checked if "All" is checked
        if (settings.selectedSalespeople && settings.selectedSalespeople.includes(salesperson)) {
          checkbox.checked = true;
        } else if (!settings.selectedSalespeople || settings.selectedSalespeople.length === 0) {
          checkbox.checked = true; // Default to all checked
        }
        
        checkbox.addEventListener('change', () => {
          // Update "All" checkbox state based on individual checkboxes
          const allIndividualCheckboxes = document.querySelectorAll('.salesperson-checkbox');
          const checkedCheckboxes = document.querySelectorAll('.salesperson-checkbox:checked');
          const allCheckbox = document.getElementById('salesperson_all');
          
          if (checkedCheckboxes.length === allIndividualCheckboxes.length) {
            allCheckbox.checked = true;
            allCheckbox.indeterminate = false;
          } else if (checkedCheckboxes.length === 0) {
            allCheckbox.checked = false;
            allCheckbox.indeterminate = false;
          } else {
            allCheckbox.checked = false;
            allCheckbox.indeterminate = true;
          }
          
          formatAndDisplay();
          saveSettings();
        });
        
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = salesperson;
        
        p.appendChild(checkbox);
        p.appendChild(label);
        container.appendChild(p);
      });
      
      // Set initial "All" checkbox state
      const allIndividualCheckboxes = document.querySelectorAll('.salesperson-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.salesperson-checkbox:checked');
      const allCheckboxFinal = document.getElementById('salesperson_all');
      
      if (checkedCheckboxes.length === allIndividualCheckboxes.length) {
        allCheckboxFinal.checked = true;
        allCheckboxFinal.indeterminate = false;
      } else if (checkedCheckboxes.length === 0) {
        allCheckboxFinal.checked = false;
        allCheckboxFinal.indeterminate = false;
      } else {
        allCheckboxFinal.checked = false;
        allCheckboxFinal.indeterminate = true;
      }
    }

    // Function to show/hide salesperson checkboxes
    function toggleSalespersonCheckboxes() {
      const select = document.getElementById('salespersonFilterSelect');
      const container = document.getElementById('salespersonCheckboxes');
      
      if (select.value === 'showSelected') {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // Function to check if a job should be included based on salesperson filter
    function shouldIncludeBySalesperson(edge) {
      const salespersonFilterSelect = document.getElementById('salespersonFilterSelect');
      
      if (salespersonFilterSelect.value === 'all') {
        return true;
      }
      
      if (salespersonFilterSelect.value === 'showSelected') {
        const selectedSalespeople = [];
        document.querySelectorAll('.salesperson-checkbox:checked').forEach(checkbox => {
          selectedSalespeople.push(checkbox.value);
        });
        
        // If no salespeople are selected, show no jobs
        if (selectedSalespeople.length === 0) {
          return false;
        }
        
        const jobSalesperson = edge.node.job.salesperson ? edge.node.job.salesperson.name.first.trim() : 'Unknown';
        return selectedSalespeople.includes(jobSalesperson);
      }
      
      return true;
    }

    // Helper function to format a date string into a friendly format.
    function formatDate(dateString) {
      const date = new Date(dateString);
      const weekdayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });
      const weekday = weekdayFormatter.format(date);
      const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'numeric', day: 'numeric' });
      let formattedDate = dateFormatter.format(date);
      formattedDate = formattedDate.replace(/(\d)(:?\d{2})\s?([AaPp][Mm])/, '$1$2$3').toLowerCase();
      return `${weekday} ${formattedDate}`;
    }

    // Helper function to format a time string from a date
    function formatTime(dateString) {
      const date = new Date(dateString);
      const timeFormatter = new Intl.DateTimeFormat('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true
      });
      return timeFormatter.format(date); //.replace(/(am|pm)/i, '').trim();
    }

    // Function to format the Jobber visits JSON into Markdown.
    function formatJobList(data, formatType) {
      formatType = formatType || 'markdown';
      const visits = data.data.visits.edges;
      
      // Sort visits based on a "geo code" extracted from the title.
      const getGeoCode = (edge) => {
        const titleParts = edge.node.title.match(/(^[^-]+)|(-[A-Z]+-)|([^-\s][^-\n]*[^-\s])|(-[^-\s][^-\n]*[^-\s])/g);
        return (titleParts && titleParts[1]) ? titleParts[1].trim() : '';
      };

      let output = '';
      const sortBySelect = document.getElementById("sortBySelect");
      const annualSelect = document.getElementById("annualSelect");
      const showDatesCheckbox = document.getElementById("showDatesCheckbox");
      const showValueCheckbox = document.getElementById("showValueCheckbox");
      const showSalespersonCheckbox = document.getElementById("showSalespersonCheckbox");
      const showRangeInfoCheckbox = document.getElementById("showRangeInfoCheckbox");
      const showTimeCheckbox = document.getElementById("showTimeCheckbox");

      let total = 0;
      let jobCount = 0;
      let jobLines = '';

      switch (sortBySelect.value) {
        case "geoCode":
          visits.sort((a, b) => {
            return getGeoCode(a).localeCompare(getGeoCode(b));
          });
          break;
        case "value":
          visits.sort((a, b) => {
            const valueA = a.node.job.total || 0;
            const valueB = b.node.job.total || 0;
            return valueB - valueA;
          });
          showValueCheckbox.checked = true;
          break;
        case "geoCodeThenValue":
          visits.sort((a, b) => {
            const geoCodeA = getGeoCode(a);
            const geoCodeB = getGeoCode(b);
            const valueA = a.node.job.total || 0;
            const valueB = b.node.job.total || 0;

            const geoCodeComparison = geoCodeA.localeCompare(geoCodeB);
            if (geoCodeComparison !== 0) {
              return geoCodeComparison;
            } else {
              return valueB - valueA;
            }
          });
          // showValueCheckbox.checked = true;
          break;
        case "alphabetical":
          visits.sort((a, b) => {
            return a.node.title.localeCompare(b.node.title);
          });
          break;
        case "salesperson":
          visits.sort((a, b) => {
            const salespersonA = a.node.job.salesperson ? a.node.job.salesperson.name.first : '';
            const salespersonB = b.node.job.salesperson ? b.node.job.salesperson.name.first : '';
            return salespersonA.localeCompare(salespersonB);
          });
          showSalespersonCheckbox.checked = true;
          break;
        case "date":
          visits.sort((a, b) => {
            return new Date(a.node.startAt) - new Date(b.node.startAt);
          });
        default:
          // Already sorted by date by default
          break;
      }
      
      // Iterate over the visits and format them.
      visits.forEach(edge => {
        // console.log('edge',edge);
        const titleParts = edge.node.title.match(/(^[^-]+)|(-[A-Z]+-)|([^-\s][^-\n]*[^-\s])|(-[^-\s][^-\n]*[^-\s])/g);
        let salespersonName = edge.node.job.salesperson ? edge.node.job.salesperson.name.first.trim() : 'Unknown';
        let includingLine = true;

        const jobIdentifier = titleParts[0].trim();
        const geoCode = titleParts[1] ? titleParts[1].trim() : '?';
        const address = titleParts[2] ? titleParts[2].trim() : '?';
        const workCode = titleParts[3] ? titleParts[3].trim() : '?';
        const jobberWebUri = edge.node.job.jobberWebUri + '?appointment_id=' + edge.node.id;
        const googleMapsUrl = `https://www.google.com/maps/place/${address.replace(/\s\/\s/g, '+').replace(/\s/g, '+')}+Spokane,WA`;
        const jobdate = formatDate(edge.node.startAt); // the JOB date

        const jobStartTime = formatTime(edge.node.startAt);
        const jobEndTime = formatTime(edge.node.endAt);
        const jobtime = (()=>{
          if (!showTimeCheckbox.checked) return '';
          let theTime = (jobStartTime && jobStartTime!=="12:00 AM") 
            && (jobEndTime && jobEndTime!=="11:59 PM")
            ? (jobStartTime + "-" + jobEndTime)
            : (jobStartTime && jobStartTime!=="12:00 AM") 
              ? jobStartTime 
              : (jobEndTime && jobEndTime!=="11:59 PM") 
              ? jobEndTime 
              : '';
          theTime = theTime.replace(/\s?(AM|PM)/gi, '').trim();
          return theTime;
        })();

        // Annual selector
        if (annualSelect.value === "include") {
          includingLine = true;
        } 
        else if (annualSelect.value === "exclude") {
          if (jobIdentifier.includes('=')) {
            includingLine = false;
          }
        } 
        else if (annualSelect.value === "excludeUnconfirmed") {
          // Show only jobs with '=' but not starting with '='
          if (jobIdentifier.includes('=') && jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        }
        else if (annualSelect.value === "annualOnly") {
          // Show only jobs with '=' in the identifier (annual jobs)
          if (!jobIdentifier.includes('=')) {
            includingLine = false;
          }
        } 
        else if (annualSelect.value === "annualOnlyConfirmed") {
          // Show only confirmed annual jobs (those with '=' but not starting with '=')
          if (!jobIdentifier.includes('=') || jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        } 
        else if (annualSelect.value === "annualOnlyUnconfirmed") {
          // Show only unconfirmed annual jobs (those with '=' but not starting with '=')
          if (!jobIdentifier.includes('=') || !jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        }

        // Salesperson filter
        if (includingLine && !shouldIncludeBySalesperson(edge)) {
          includingLine = false;
        }

        // Text filter
        if (includingLine) {
          const filterInput = document.getElementById('filterInput');
          const filterText = filterInput ? filterInput.value.toLowerCase().trim() : '';
          if (filterText && !edge.node.title.toLowerCase().includes(filterText)) {
            includingLine = false;
          }
        }

        if (includingLine) {
          jobCount++;
          total += edge.node.job.total || 0;

          // Get current date display setting
          const dateDisplaySetting = getDateDisplaySetting();

          // If formatType is 'markdown', format the output as Markdown.
          if (formatType === 'markdown') {
            // Dates
            if (dateDisplaySetting === "all") {
              jobLines += ` **\`${jobdate}\`** `;
            } else if (dateDisplaySetting === "weekdayOnly" && !jobdate.startsWith("Sun ")) {
              jobLines += ` **\`${jobdate}\`** `;
            }

            // Format the job line as Markdown.
            jobLines += `[**${jobIdentifier}**](${jobberWebUri}) ${geoCode} [${address}](${googleMapsUrl}) - ${workCode}`;

            // Time
            if (showTimeCheckbox.checked && jobtime!=='') {
              jobLines += ` **\`${jobtime}\`**`;
            }

            // Value and Salesperson checkboxes
            if (showValueCheckbox.checked) {
              jobLines += ` \`$${edge.node.job.total ? edge.node.job.total : '?'}\``;
            }
            if (showSalespersonCheckbox.checked) {
              jobLines += ` \`${salespersonName}\``;
            }
          } else if (formatType === 'plaintext') {
            jobLines += `${jobIdentifier} ${geoCode} ${address} - ${workCode}`;
            if (dateDisplaySetting === "all") {
              jobLines += ` ${jobdate}`;
            } else if (dateDisplaySetting === "weekdayOnly" && !jobdate.startsWith("Sun ")) {
              jobLines += ` ${jobdate}`;
            }
            if (showTimeCheckbox.checked) {
              jobLines += ` ${jobtime}`;
            }
            if (showValueCheckbox.checked) {
              jobLines += ` - $${edge.node.job.total ? edge.node.job.total : '?'}`;
            }
            if (showSalespersonCheckbox.checked) {
              jobLines += ` - ${salespersonName}`;
            }
          }

          jobLines += '\n\n';
        }
      });
      
      if (formatType === 'markdown') {
        // Range info
        if (showRangeInfoCheckbox.checked) {
          const formattedStartDate = formatDate(STARTDATE);
          const formattedEndDate = formatDate(ENDDATE);
          if (showValueCheckbox.checked) {
            output += `# **${formattedStartDate} - ${formattedEndDate}** **\`${jobCount} Jobs\`** **\`$${total}\`**\n\n`;
          } else {
            output += `# **${formattedStartDate} - ${formattedEndDate}** **\`${jobCount} Jobs\`**\n\n`;
          }
        }
      } else if (formatType === 'plaintext') {
        // Range info
        if (showRangeInfoCheckbox.checked) {
          const formattedStartDate = formatDate(STARTDATE);
          const formattedEndDate = formatDate(ENDDATE);
          if (showValueCheckbox.checked) {
            output += `${formattedStartDate} - ${formattedEndDate}, ${jobCount} Jobs, $${total}\n\n------------------------------\n\n`;
          } else {
            output += `${formattedStartDate} - ${formattedEndDate}, ${jobCount} Jobs\n\n------------------------------\n\n`;
          }
        }
      }

      output += jobLines;
      
      return output;
    }

    function renderMarkdown() {
      const markdownOutput = document.getElementById('markdown-output').value;
      const markdownContainer = document.getElementById('renderedMarkdown');
      markdownContainer.innerHTML = "";
      let markdownedHTML = marked.use({
        gfm: true,
        breaks: true
      }).parse(markdownOutput);
      markdownContainer.innerHTML = markdownedHTML;
    }

    // Format and display the Markdown output.
    function formatAndDisplay() {
      const data = DATA;
      const formattedMarkdown = formatJobList(data, 'markdown');
      markdownOutput.value = formattedMarkdown;
      renderMarkdown();
    }

    // Fetch visits from the server and update the page.
    async function fetchVisits() {
      if (!STARTDATE || !ENDDATE) {
        alert("Please select both start and end dates.");
        return;
      }

      // Format dates for API call using UTC to match database format
      function formatUTCDate(date) {
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // Create a new date object for the end date + 1 day using local time
      const endDatePlusOne = new Date(ENDDATE);
      endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);
      endDatePlusOne.setHours(0, 0, 0, 0); // Set to beginning of day

      const startDateStr = formatUTCDate(STARTDATE);
      const extendedEndDate = formatUTCDate(endDatePlusOne);

      const startParam = startDateStr + "T00:00:00Z";
      const endParam = extendedEndDate + "T00:00:00Z";

      // console.log('=== FETCH VISITS DEBUG (UTC FIXED) ===');
      // console.log('Original STARTDATE:', STARTDATE);
      // console.log('Original ENDDATE:', ENDDATE);
      // console.log('End date + 1 day (local):', endDatePlusOne);
      // console.log('Formatted startDateStr (UTC):', startDateStr);
      // console.log('Extended endDate (UTC):', extendedEndDate);
      // console.log('Start parameter:', startParam);
      // console.log('End parameter:', endParam);
      // console.log('Full API URL:', `/api/visits?startDate=${encodeURIComponent(startParam)}&endDate=${encodeURIComponent(endParam)}`);
    
      // Fetch the visits from the server.
      try {
        const response = await fetch(
          `/api/visits?startDate=${encodeURIComponent(startParam)}&endDate=${encodeURIComponent(endParam)}`,
          { headers: { 'Accept': 'application/json' } }
        );
    
        // If not authenticated, redirect to OAuth login.
        if (response.status === 401) {
          window.location.href = '/auth/jobber';
          return;
        }
    
        if (!response.ok) {
          throw new Error("Network response was not ok.");
        }
    
        const data = await response.json();
        console.log('API Response data:', data);
        // console.log('Number of visits returned:', data?.data?.visits?.edges?.length || 0);
        
        // Log first few visits for debugging
        // if (data?.data?.visits?.edges?.length > 0) {
        //   console.log('First 3 visits:', data.data.visits.edges.slice(0, 3).map(edge => ({
        //     title: edge.node.title,
        //     startAt: edge.node.startAt,
        //     date: new Date(edge.node.startAt).toLocaleDateString()
        //   })));
        // }
        
        DATA = data;
        populateSalespersonCheckboxes(data);
        toggleSalespersonCheckboxes();
        formatAndDisplay();
      } catch (error) {
        console.error("Error fetching visits:", error);
        alert("Error fetching visits. Please try again.");
      }
    }

    const annualSelect = document.getElementById('annualSelect');
    const sortBySelect = document.getElementById("sortBySelect");
    const showDatesCheckbox = document.getElementById("showDatesCheckbox");
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const radioButtons = document.querySelectorAll('input[name="dateDisplay"]');
    const markdownOutput = document.getElementById('markdown-output');

    markdownOutput.addEventListener('input', () => {
      const value = markdownOutput.value;
      if (value) {
      renderMarkdown();
      }
    });

    annualSelect.addEventListener('change', () => {
      formatAndDisplay();
      saveSettings();
    });

    sortBySelect.addEventListener('change', () => {
      formatAndDisplay();
      saveSettings();
    });

    showDatesCheckbox.addEventListener('change', () => {
      toggleDateOptions();
      formatAndDisplay();
      saveSettings();
    });

    // Add event listeners for radio buttons
    radioButtons.forEach(radio => {
      radio.addEventListener('change', () => {
        formatAndDisplay();
        saveSettings();
      });
    });

    // Add event listener for salesperson filter select
    document.getElementById('salespersonFilterSelect').addEventListener('change', () => {
      toggleSalespersonCheckboxes();
      formatAndDisplay();
      saveSettings();
    });

    // Add event listener for filter input
    const filterInput = document.getElementById('filterInput');
    if (filterInput) {
      filterInput.addEventListener('input', () => {
        formatAndDisplay();
      });
    }

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        if (checkbox.id === 'showDatesCheckbox') {
          toggleDateOptions();
        }
        formatAndDisplay();
        saveSettings();
      });
    });

    // Refresh button logic
    document.getElementById('refreshDataBtn').addEventListener('click', function() {
      const btn = this;
      const originalText = btn.textContent;
      
      // Show loading state
      btn.textContent = '‚ü≥ Refreshing...';
      btn.disabled = true;
      btn.style.background = '#666';
      
      // Fetch new data
      fetchVisits().finally(() => {
        // Reset button state
        btn.textContent = originalText;
        btn.disabled = false;
        btn.style.background = '#388523';
      });
    });
    // Copy button logic
    document.addEventListener('DOMContentLoaded', function() {
      // Copy dropdown logic
      const markdownOutput = document.getElementById('markdown-output');
      const renderedMarkdown = document.getElementById('renderedMarkdown');
      const copyContainer = document.querySelector('.copy-dropdown-container');
      const copyTrigger = document.getElementById('copyDropdownTrigger');
      const copyMenu = document.getElementById('copyDropdownMenu');
      const copyItems = document.querySelectorAll('.copy-dropdown-item');
      
      let activeIndicator = null;
      let fadeTimer = null;
      let removeTimer = null;

      // Toggle dropdown menu
      copyTrigger.addEventListener('click', function(e) {
        e.stopPropagation();
        copyMenu.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function() {
        copyMenu.classList.remove('show');
      });

      // Prevent menu from closing when clicking inside it
      copyMenu.addEventListener('click', function(e) {
        e.stopPropagation();
      });

      function showCopied(text) {
        // Clean previous
        if (fadeTimer) clearTimeout(fadeTimer);
        if (removeTimer) clearTimeout(removeTimer);
        if (activeIndicator && activeIndicator.parentNode) {
          activeIndicator.parentNode.removeChild(activeIndicator);
        }

        // Create fresh element every time
        const span = document.createElement('span');
        span.className = 'copied-indicator';
        span.textContent = text;
        copyContainer.appendChild(span);

        // Force layout, then fade in
        span.style.transition = 'none';
        span.style.opacity = '0';
        requestAnimationFrame(() => {
          span.style.transition = 'opacity 180ms ease';
          span.style.opacity = '1';
        });

        // Schedule fade out
        fadeTimer = setTimeout(() => {
          span.style.transition = 'opacity 220ms ease';
          span.style.opacity = '0';
          removeTimer = setTimeout(() => {
            if (span.parentNode) span.parentNode.removeChild(span);
            if (activeIndicator === span) activeIndicator = null;
          }, 260);
        }, 2000);

        activeIndicator = span;
      }

      function copyToClipboard(text) {
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          const result = document.execCommand('copy');
          document.body.removeChild(textArea);
          return result;
        } catch (err) {
          console.error('Copy failed:', err);
          return false;
        }
      }

      // Handle copy item clicks
      copyItems.forEach(item => {
        item.addEventListener('click', function() {
          const copyType = this.getAttribute('data-copy-type');
          copyMenu.classList.remove('show');
          
          let success = false;
          
          try {
            if (copyType === 'markdown') {
              success = copyToClipboard(markdownOutput.value);
              if (success) showCopied('Copied Markdown');
            } else if (copyType === 'richtext') {
              if (!renderedMarkdown.innerHTML.trim()) {
                alert('Activate preview first.');
                return;
              }
              
              // Try selection-based copy for rich text
              try {
                const range = document.createRange();
                range.selectNodeContents(renderedMarkdown);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                success = document.execCommand('copy');
                sel.removeAllRanges();
                
                if (!success) {
                  // Fallback to plain text
                  success = copyToClipboard(renderedMarkdown.innerText);
                }
              } catch (selectionErr) {
                success = copyToClipboard(renderedMarkdown.innerText);
              }
              
              if (success) showCopied('Copied Rich Text');
            } else if (copyType === 'plaintext') {
              if (!DATA) {
                alert('No data yet.');
                return;
              }
              const plain = formatJobList(DATA, 'plaintext');
              success = copyToClipboard(plain);
              if (success) showCopied('Copied Plain Text');
            }
            
            if (!success) {
              alert('Copy failed. Try selecting the text manually and using Ctrl+C (or Cmd+C on Mac).');
            }
            
          } catch (e) {
            console.error('Copy operation failed:', e);
            alert('Copy failed. Try selecting the text manually and using Ctrl+C (or Cmd+C on Mac).');
          }
        });
      });

      // Markdown preview toggle logic
      const previewMarkdownBtn = document.getElementById('previewMarkdownBtn');
      let isMarkdownPreviewing = true;
  
      function updateMarkdownPreview() {
        if (isMarkdownPreviewing) {
          // Show rendered markdown, hide textarea
          markdownOutput.style.display = 'none';
          renderedMarkdown.style.display = '';
          previewMarkdownBtn.classList.add('active');
          // Render markdown
          renderedMarkdown.innerHTML = marked.parse(markdownOutput.value, { gfm: true, breaks: true });
        } else {
          // Show textarea, hide rendered markdown
          markdownOutput.style.display = '';
          renderedMarkdown.style.display = 'none';
          previewMarkdownBtn.classList.remove('active');
        }
      }
    
      if (previewMarkdownBtn) {
        previewMarkdownBtn.addEventListener('click', function() {
          isMarkdownPreviewing = !isMarkdownPreviewing;
          updateMarkdownPreview();
        });
      }
    
      // Initialize preview state on load
      updateMarkdownPreview();

      // Mobile navigation functionality
      let currentPanel = 0;
      let navigationInitialized = false;

      function initMobileNavigation() {
        if (window.innerWidth <= 768 && !navigationInitialized) {
          // Button navigation - attach listeners only once
          document.getElementById('viewListBtn').addEventListener('click', () => navigateToPanel(1));
          document.getElementById('optionsBtn').addEventListener('click', () => navigateToPanel(0));
          navigationInitialized = true;
        } else if (window.innerWidth > 768) {
          navigationInitialized = false; // Reset for mobile when resizing
        }
      }

      function navigateToPanel(panelIndex) {
        currentPanel = panelIndex;
        const wrapper = document.getElementById('wrapper');
        const viewListBtn = document.getElementById('viewListBtn');
        const optionsBtn = document.getElementById('optionsBtn');
        
        if (panelIndex === 0) {
          // Show options panel
          wrapper.classList.remove('show-output');
          viewListBtn.style.display = 'block';
          optionsBtn.style.display = 'none';
        } else {
          // Show output panel
          wrapper.classList.add('show-output');
          viewListBtn.style.display = 'none';
          optionsBtn.style.display = 'block';
        }
      }

      // Initialize navigation on load and resize
      window.addEventListener('DOMContentLoaded', initMobileNavigation);
      window.addEventListener('resize', initMobileNavigation);
    });
  </script>
</body>
</html>
