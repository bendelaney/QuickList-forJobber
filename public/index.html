<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
		body {
			font-family: 'Inter', sans-serif;
			background-color: fff;
			color: #333;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
		}
    label {
      font-weight: bold;

      span {font-weight: normal;}
    }
    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.5);
    }

    #wrapper {
      display: flex;
      justify-content: space-between;
      flex: 1;
      min-height: 0;
    }

    #sidebar {
      background: #f1f0e9;
      padding: 20px;
      border-right: 1px solid rgb(223, 221, 210);
      max-width: 400px;
    }

    header h1 {
			font-size: 20px;
			color: #1a1a1a;
			margin: 0 0 20px 0;
      padding: 0;
		}

    #optionsContainer {
      font-size: 0.85em;

      .dates {
        display: flex;
        align-items: center;
      }
      .dates label {
        margin-right: 5px;
        flex: 2;
      }
      #startDate, #endDate {
        font-size: 16px;
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #aaa;
        font-weight: bold;
        flex: 2;
      }
      label {
        margin-right: 5px;
        flex: 1;
      }
      select {
        flex: 1.4;
      }
      p {
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
      }
    }

    #outputContainer {
      flex: 3;
      display: flex;
      min-height: 0; /* Important for flex children to respect parent height */
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
      flex-direction: column;
      position: relative;
    }

    .output {
      flex: 1 1 0;
      min-height: 100px;
      font-family: monospace;
      box-sizing: border-box;
      padding: 12px;
      border: none;
      resize: none;
      font-size: 11px;
      background-color: #efefef;
      overflow: auto;
      box-shadow: 0 2px 5px inset rgba(0,0,0,0.2);
      &:focus {
        outline: none;
      }
    }

    #renderedMarkdown {
      flex: 1 1 0;
      min-height: 100px;
      box-sizing: border-box;
      padding: 12px;
      border: none;
      border-radius: 0;
      font-size: 0.85em;
      background-color: #efefef;
      overflow: auto;
      background-color: white;
      box-shadow: 0 2px 5px inset rgba(0,0,0,0.2);
      
      h1, h2, h3 {
        margin-top: 0;
        font-size: 1.25em;
      }
      p {
        margin: 0;
        padding: 2px 0;
        line-height: 1.75;
      }
      code {
        padding: 1px 4px;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 3px;
      }
    }

    select {
      font-size: 13px;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #aaa;
      width: 100%;
    }
    
    @media (max-width: 768px) {
      #wrapper {
        flex-direction: column;
      }
      
      #optionsContainer {
        max-width: 100%;
        margin-right: 0;
        margin-bottom: 20px;
      }
      
      #sidebar {
        width: 100%;
        max-width: none;
        border-right: none;
        border-bottom: 1px solid rgb(223, 221, 210);
        padding: 16px 10px;
        box-sizing: border-box;
      }
      
      #outputContainer {
        flex-direction: column;
        height: auto;
        max-height: 70vh;
        padding: 0;
        gap: 0;
      }
      
      textarea.output, #renderedMarkdown {
        width: 100%;
        min-height: 200px;
        border-radius: 0;
      }
    }
    
    /* Copy button styles */
    .copy-btn-container {
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      align-items: center;
      position: relative;
      padding: 10px;
    }

    .copy-button, .preview-button {
      background: #f1f0e9;
      border: 1px solid #bbb;
      border-radius: 4px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      margin-right: 2px;
    }
    .preview-button.active {
      background: rgb(56, 133, 35);
      color: #fff;
      border: 1px solid #aaa;
      box-shadow: inset 0 0 5px rgb(30, 91, 14);
    }
    #copyOutputBtn:active {
      background: #e0dfd6;
    }

    @media (max-width: 768px) {
      .copy-btn-container {
        button {
          margin-right: 0;
        }
      }
      #copyOutputBtn {
        font-size: 15px;
        padding: 10px 18px;
      }
    }

    /* Tab styles */
    .tab-bar {
      display: flex;
      border-bottom: 1px solid #ccc;
      background: #f8f8f8;
      border-radius: 4px 4px 0 0;
    }
    .tab-btn {
      flex: 1;
      padding: 10px 0;
      background: none;
      border: none;
      font-size: 1em;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      outline: none;
    }
    .tab-btn.active {
      background: #fff;
      color: #222;
      border-bottom: 4px solid #388523;
      z-index: 1;
    }
    .tab-btn:not(.active):hover {
      background: #f1f0e9;
      color: #444;
    }

    /* Hide inactive tab content */
    .tab-content {
      display: none;
      height: 100%;
    }
    .tab-content.active {
      display: flex;
      flex: 1;
      flex-direction: column;
      height: 100%;
    }

    @media (max-width: 768px) {
      .tab-bar {
        font-size: 1.1em;
      }
    }
  </style>
  <script>
    // Pre-authentication: On page load, check if the user is authenticated.
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/authenticated', { headers: { 'Accept': 'application/json' } });
        if (!response.ok) {
          throw new Error('Not authenticated');
        }
        console.log('User is authenticated');
      } catch (error) {
        console.log('Not authenticated, redirecting to login...');
        window.location.href = '/auth/jobber';
        return;
      }

      // Compute the next Sunday (if today is Sunday, use 7 days from now).
      function getNextSunday() {
        const now = new Date();
        const day = now.getDay(); // Sunday = 0, Monday = 1, ..., Saturday = 6
        let daysUntilSunday = (7 - day) % 7;
        if (daysUntilSunday === 0) daysUntilSunday = 0;
        const nextSunday = new Date(now);
        nextSunday.setDate(now.getDate() + daysUntilSunday);
        return nextSunday;
      }

      // Compute the Friday following the given Sunday.
      function getFollowingFriday(fromSunday) {
        const friday = new Date(fromSunday);
        friday.setDate(fromSunday.getDate() + 5); // Friday is 5 days after Sunday
        return friday;
      }

      // Format a date as YYYY-MM-DD for the date input.
      function formatDateInput(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      const nextSunday = getNextSunday();
      STARTDATE = nextSunday;
      const followingFriday = getFollowingFriday(nextSunday);
      ENDDATE = followingFriday;
      document.getElementById('startDate').value = formatDateInput(nextSunday);
      document.getElementById('endDate').value = formatDateInput(followingFriday);

      // Auto load fetch visits
      const settings = loadSettings();
      applySettings(settings);
      fetchVisits();
    });
  </script>

  <title>Jobber Visits To Markdown</title>
</head>
<body>
  <div id="wrapper">
    <div id="sidebar">
      <header>
        <h1>Jobber Visits to Markdown</h1>
      </header>
  
      <div id="optionsContainer">
        <p class="dates">
          <label for="startDate">Start Date:</label>
          <input type="date" id="startDate" name="startDate">
        </p>
        <p class="dates">
          <label for="endDate">End Date:</label>
          <input type="date" id="endDate" name="endDate">
        </p>      
        
        <h4>Output Options:</h4>
        <p>
          <label for="sortBySelect">Sort by:</label>
          <select id="sortBySelect">
            <option value="date">Date</option>
            <option value="geoCode">GeoCode</option>
            <option value="value">$ Value</option>
            <option value="geoCodeThenValue">GeoCode, then $ Value</option>
            <option value="alphabetical">Alphabetical</option>
            <option value="salesperson">Salesperson</option>
          </select>
        </p>
  
        <p>
          <label for="annualSelect">Annual Jobs:</label>
          <select id="annualSelect">
            <option value="include" selected>Include Annual Jobs</option>
            <option value="exclude">Exclude Annual Jobs</option>
            <option value="excludeUnconfirmed">Exclude Unconfirmed Annual Jobs</option>
            <option value="annualOnly">Show Only Annual Jobs</option>
            <option value="annualOnlyConfirmed">Show Only *Confirmed* Annual Jobs</option>
            <option value="annualOnlyUnconfirmed">Show Only *Unconfirmed* Annual Jobs</option>
          </select>
        </p>
  
        <p>
          <label for="showDatesSelect">Show Dates:</label>
          <select id="showDatesSelect">
            <option value="none" selected>Don't Show Dates</option>
            <option value="all">Show All Job Dates</option>
            <option value="weekdayOnly">Show Only Weekday Job Dates</option>
          </select>
        </p>
        <p><input type="checkbox" id="showValueCheckbox"><label for="showValueCheckbox">Show $ Value</label></p>
        <p><input type="checkbox" id="showSalespersonCheckbox"><label for="showSalespersonCheckbox">Show Salesperson</label></p>
        <p><input type="checkbox" id="showRangeInfoCheckbox" checked><label for="showRangeInfoCheckbox">Include Range Info <span>(at top of list)</span></label></p>

        <p>
          <button id="refreshDataBtn" style="
            background: #388523; 
            color: white; 
            border: 1px solid #2a6619; 
            border-radius: 4px; 
            padding: 10px 20px; 
            font-size: 13px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%;
            transition: background 0.2s;
          " onmouseover="this.style.background='#2a6619'" onmouseout="this.style.background='#388523'">
            Fetch Data
          </button>
        </p>
      </div>

      
    </div>

    <div id="outputContainer">
      <div class="tab-bar">
        <button class="tab-btn active" id="markdownTabBtn" type="button">Markdown</button>
        <button class="tab-btn" id="plaintextTabBtn" type="button">Plain Text</button>
      </div>
      <div class="tab-content active" id="markdownTab">
        <div class="copy-btn-container">
          <button id="previewMarkdownBtn" class="preview-button" title="Preview Markdown">Preview</button>
          <button id="copyMarkdownOutputBtn" class="copy-button" title="Copy Markdown">Copy Markdown</button>
        </div>
        <textarea id="markdown-output" class="output" placeholder="Your Markdown will go here."></textarea>
        <div id="renderedMarkdown" style="display:none;"></div>
      </div>
      <div class="tab-content" id="plaintextTab">
        <div class="copy-btn-container">
          <button id="copyPlaintextOutputBtn" class="copy-button" title="Copy Text">Copy Text</button>
        </div>
        <textarea id="plaintext-output" class="output" placeholder="Your text will go here."></textarea>
      </div>
    </div>
  </div>

  <script>
    let DATA = null;
    let STARTDATE = null;
    let ENDDATE = null;

    const DEFAULT_SETTINGS = {
      sortBy: "date",
      annual: "include",
      showDates: "none",
      showValue: false,
      showSalesperson: false,
      showRangeInfo: true
    };

    // Function to save current settings to localStorage
    function saveSettings() {
      const currentSettings = {
        sortBy: sortBySelect.value,
        annual: annualSelect.value,
        showDates: showDatesSelect.value,
        showValue: showValueCheckbox.checked,
        showSalesperson: showSalespersonCheckbox.checked,
        showRangeInfo: showRangeInfoCheckbox.checked
      };
      
      localStorage.setItem('jobberSettings', JSON.stringify(currentSettings));
      console.log('Settings saved:', currentSettings);
    }

    // Function to load settings from localStorage
    function loadSettings() {
      try {
        const savedSettings = localStorage.getItem('jobberSettings');
        if (savedSettings) {
          return JSON.parse(savedSettings);
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
      return DEFAULT_SETTINGS; // Return defaults if nothing saved or error
    }

    // Function to apply settings to form elements
    function applySettings(settings) {
      sortBySelect.value = settings.sortBy;
      annualSelect.value = settings.annual;
      showDatesSelect.value = settings.showDates;
      showValueCheckbox.checked = settings.showValue;
      showSalespersonCheckbox.checked = settings.showSalesperson;
      showRangeInfoCheckbox.checked = settings.showRangeInfo;
    }

    // Helper function to format a date string into a friendly format.
    function formatDate(dateString) {
      const date = new Date(dateString);
      const weekdayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });
      const weekday = weekdayFormatter.format(date);
      const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'numeric', day: 'numeric' });
      let formattedDate = dateFormatter.format(date);
      formattedDate = formattedDate.replace(/(\d)(:?\d{2})\s?([AaPp][Mm])/, '$1$2$3').toLowerCase();
      return `${weekday} ${formattedDate}`;
    }

    // Function to format the Jobber visits JSON into Markdown.
    function formatJobList(data, formatType) {
      formatType = formatType || 'markdown';
      const visits = data.data.visits.edges;
      
      // Sort visits based on a "geo code" extracted from the title.
      const getGeoCode = (edge) => {
        const titleParts = edge.node.title.match(/(^[^-]+)|(-[A-Z]+-)|([^-\s][^-\n]*[^-\s])|(-[^-\s][^-\n]*[^-\s])/g);
        return (titleParts && titleParts[1]) ? titleParts[1].trim() : '';
      };

      let output = '';
      const sortBySelect = document.getElementById("sortBySelect");
      const annualSelect = document.getElementById("annualSelect");
      const showDatesSelect = document.getElementById("showDatesSelect");
      const showValueCheckbox = document.getElementById("showValueCheckbox");
      const showSalespersonCheckbox = document.getElementById("showSalespersonCheckbox");
      const showRangeInfoCheckbox = document.getElementById("showRangeInfoCheckbox");

      let total = 0;
      let jobCount = 0;
      let jobLines = '';

      switch (sortBySelect.value) {
        case "geoCode":
          visits.sort((a, b) => {
            return getGeoCode(a).localeCompare(getGeoCode(b));
          });
          break;
        case "value":
          visits.sort((a, b) => {
            const valueA = a.node.job.total || 0;
            const valueB = b.node.job.total || 0;
            return valueB - valueA;
          });
          showValueCheckbox.checked = true;
          break;
        case "geoCodeThenValue":
          visits.sort((a, b) => {
            const geoCodeA = getGeoCode(a);
            const geoCodeB = getGeoCode(b);
            const valueA = a.node.job.total || 0;
            const valueB = b.node.job.total || 0;

            const geoCodeComparison = geoCodeA.localeCompare(geoCodeB);
            if (geoCodeComparison !== 0) {
              return geoCodeComparison;
            } else {
              return valueB - valueA;
            }
          });
          // showValueCheckbox.checked = true;
          break;
        case "alphabetical":
          visits.sort((a, b) => {
            return a.node.title.localeCompare(b.node.title);
          });
          break;
        case "salesperson":
          visits.sort((a, b) => {
            const salespersonA = a.node.job.salesperson ? a.node.job.salesperson.name.first : '';
            const salespersonB = b.node.job.salesperson ? b.node.job.salesperson.name.first : '';
            return salespersonA.localeCompare(salespersonB);
          });
          showSalespersonCheckbox.checked = true;
          break;
        case "date":
          visits.sort((a, b) => {
            return new Date(a.node.startAt) - new Date(b.node.startAt);
          });
        default:
          // Already sorted by date by default
          break;
      }
      
      // Iterate over the visits and format them.
      visits.forEach(edge => {
        const titleParts = edge.node.title.match(/(^[^-]+)|(-[A-Z]+-)|([^-\s][^-\n]*[^-\s])|(-[^-\s][^-\n]*[^-\s])/g);
        let salespersonName = edge.node.job.salesperson ? edge.node.job.salesperson.name.first.trim() : 'Unknown';
        let includingLine = true;

        const jobIdentifier = titleParts[0].trim();
        const geoCode = titleParts[1] ? titleParts[1].trim() : '?';
        const address = titleParts[2] ? titleParts[2].trim() : '?';
        const workCode = titleParts[3] ? titleParts[3].trim() : '?';
        const jobberWebUri = edge.node.job.jobberWebUri;
        const googleMapsUrl = `https://www.google.com/maps/place/${address.replace(/\s\/\s/g, '+').replace(/\s/g, '+')}+Spokane,WA`;
        const jobdate = formatDate(edge.node.startAt);

        // Annual selector
        if (annualSelect.value === "include") {
          includingLine = true;
        } 
        else if (annualSelect.value === "exclude") {
          if (jobIdentifier.includes('=')) {
            includingLine = false;
          }
        } 
        else if (annualSelect.value === "excludeUnconfirmed") {
          // Show only jobs with '=' but not starting with '='
          if (jobIdentifier.includes('=') && jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        }
        else if (annualSelect.value === "annualOnly") {
          // Show only jobs with '=' in the identifier (annual jobs)
          if (!jobIdentifier.includes('=')) {
            includingLine = false;
          }
        } 
        else if (annualSelect.value === "annualOnlyConfirmed") {
          // Show only confirmed annual jobs (those with '=' but not starting with '=')
          if (!jobIdentifier.includes('=') || jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        } 
        else if (annualSelect.value === "annualOnlyUnconfirmed") {
          // Show only unconfirmed annual jobs (those with '=' but not starting with '=')
          if (!jobIdentifier.includes('=') || !jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        } 

        if (includingLine) {
          jobCount++;
          total += edge.node.job.total || 0;

          // If formatType is 'markdown', format the output as Markdown.
          if (formatType === 'markdown') {
            // Format the job line as Markdown.
            jobLines += `[**${jobIdentifier}**](${jobberWebUri}) ${geoCode} [${address}](${googleMapsUrl}) - ${workCode}`;

            // Dates
            if (showDatesSelect.value === "all") {
              jobLines += ` **\`${jobdate}\`**`;
            } else if (showDatesSelect.value === "weekdayOnly" && !jobdate.startsWith("Sun ")) {
              jobLines += ` **\`${jobdate}\`**`;
            }

            // Value and Salesperson checkboxes
            if (showValueCheckbox.checked) {
              jobLines += ` \`$${edge.node.job.total ? edge.node.job.total : '?'}\``;
            }
            if (showSalespersonCheckbox.checked) {
              jobLines += ` \`${salespersonName}\``;
            }
          } else if (formatType === 'plaintext') {
            jobLines += `${jobIdentifier} ${geoCode} ${address} - ${workCode}`;
            if (showDatesSelect.value === "all") {
              jobLines += ` ${jobdate}`;
            } else if (showDatesSelect.value === "weekdayOnly" && !jobdate.startsWith("Sun ")) {
              jobLines += ` ${jobdate}`;
            }
            if (showValueCheckbox.checked) {
              jobLines += ` - $${edge.node.job.total ? edge.node.job.total : '?'}`;
            }
            if (showSalespersonCheckbox.checked) {
              jobLines += ` - ${salespersonName}`;
            }
          }

          jobLines += '\n\n';
        }
      });
      
      if (formatType === 'markdown') {
        // Range info
        if (showRangeInfoCheckbox.checked) {
          const formattedStartDate = formatDate(STARTDATE);
          const formattedEndDate = formatDate(ENDDATE);
          if (showValueCheckbox.checked) {
            output += `# **${formattedStartDate} - ${formattedEndDate}** **\`${jobCount} Jobs\`** **\`$${total}\`**\n\n`;
          } else {
            output += `# **${formattedStartDate} - ${formattedEndDate}** **\`${jobCount} Jobs\`**\n\n`;
          }
        }
      } else if (formatType === 'plaintext') {
        // Range info
        if (showRangeInfoCheckbox.checked) {
          const formattedStartDate = formatDate(STARTDATE);
          const formattedEndDate = formatDate(ENDDATE);
          if (showValueCheckbox.checked) {
            output += `${formattedStartDate} - ${formattedEndDate}, ${jobCount} Jobs, $${total}\n\n------------------------------\n\n`;
          } else {
            output += `${formattedStartDate} - ${formattedEndDate}, ${jobCount} Jobs\n\n------------------------------\n\n`;
          }
        }
      }

      output += jobLines;
      
      return output;
    }

    function renderMarkdown() {
      const markdownOutput = document.getElementById('markdown-output').value;
      const markdownContainer = document.getElementById('renderedMarkdown');
      markdownContainer.innerHTML = "";
      let markdownedHTML = marked.use({
        gfm: true,
        breaks: true
      }).parse(markdownOutput);
      markdownContainer.innerHTML = markdownedHTML;
    }

    // Format and display the Markdown output.
    function formatAndDisplay() {
      const data = DATA;
      // const markdownOutput = document.getElementById('markdown-output');
      const plainTextOutput = document.getElementById('plaintext-output');
      const formattedMarkdown = formatJobList(data, 'markdown');
      const formattedPlainText = formatJobList(data, 'plaintext');
      markdownOutput.value = "";
      markdownOutput.value = formattedMarkdown;
      plainTextOutput.value = "";
      plainTextOutput.value = formattedPlainText;

      renderMarkdown();
    }


    // Fetch visits from the server and update the page.
    async function fetchVisits() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        alert("Please select both start and end dates.");
        return;
      }
    
      // Add one day to end date to ensure we capture the full end date
      const endDateObj = new Date(endDate);
      endDateObj.setDate(endDateObj.getDate() + 1);
      const extendedEndDate = endDateObj.toISOString().split('T')[0];
    
      // Fetch the visits from the server.
      try {
        const response = await fetch(
          `/api/visits?startDate=${encodeURIComponent(startDate + "T00:00:00")}&endDate=${encodeURIComponent(extendedEndDate + "T00:00:00")}`,
          { headers: { 'Accept': 'application/json' } }
        );
    
        // If not authenticated, redirect to OAuth login.
        if (response.status === 401) {
          window.location.href = '/auth/jobber';
          return;
        }
    
        if (!response.ok) {
          throw new Error("Network response was not ok.");
        }
    
        const data = await response.json();
        console.log(data);
        DATA = data;
        formatAndDisplay();
      } catch (error) {
        console.error("Error fetching visits:", error);
        alert("Error fetching visits. Please try again.");
      }
    }
    
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const annualSelect = document.getElementById('annualSelect');
    const sortBySelect = document.getElementById("sortBySelect");
    const showDatesSelect = document.getElementById("showDatesSelect");
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const markdownOutput = document.getElementById('markdown-output');

    markdownOutput.addEventListener('input', () => {
      const value = markdownOutput.value;
      if (value) {
      renderMarkdown();
      }
    });

    startDateInput.addEventListener('change', () => {
      STARTDATE = startDateInput.value;
      fetchVisits();
    });

    endDateInput.addEventListener('change', () => {
      ENDDATE = endDateInput.value;
      fetchVisits();
    });
    annualSelect.addEventListener('change', () => {
      formatAndDisplay();
      saveSettings();
    });

    sortBySelect.addEventListener('change', () => {
      formatAndDisplay();
      saveSettings();
    });

    showDatesSelect.addEventListener('change', () => {
      formatAndDisplay();
      saveSettings();
    });

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        formatAndDisplay();
        saveSettings();
      });
    });

    // Refresh button logic
    document.getElementById('refreshDataBtn').addEventListener('click', function() {
      const btn = this;
      const originalText = btn.textContent;
      
      // Show loading state
      btn.textContent = 'âŸ³ Refreshing...';
      btn.disabled = true;
      btn.style.background = '#666';
      
      // Fetch new data
      fetchVisits().finally(() => {
        // Reset button state
        btn.textContent = originalText;
        btn.disabled = false;
        btn.style.background = '#388523';
      });
    });
    // Copy button logic
    document.addEventListener('DOMContentLoaded', function() {
      // Markdown copy button
      const copyMarkdownBtn = document.getElementById('copyMarkdownOutputBtn');
      const markdownOutput = document.getElementById('markdown-output');
      const renderedMarkdown = document.getElementById('renderedMarkdown');
      if (copyMarkdownBtn && markdownOutput && renderedMarkdown) {
        copyMarkdownBtn.addEventListener('click', function() {
          // If textarea is hidden, temporarily show it off-screen for copy
          let restoreDisplay = null;
          if (markdownOutput.style.display === 'none') {
            restoreDisplay = markdownOutput.style.display;
            markdownOutput.style.position = 'absolute';
            markdownOutput.style.left = '-9999px';
            markdownOutput.style.display = 'block';
          }
          markdownOutput.select();
          markdownOutput.setSelectionRange(0, 99999);
          document.execCommand('copy');
          if (restoreDisplay !== null) {
            markdownOutput.style.display = restoreDisplay;
            markdownOutput.style.position = '';
            markdownOutput.style.left = '';
          }
          copyMarkdownBtn.textContent = 'Copied!';
          setTimeout(() => { copyMarkdownBtn.textContent = 'Copy Markdown'; }, 1200);
        });
      }

      // Plaintext copy button
      const copyPlaintextBtn = document.getElementById('copyPlaintextOutputBtn');
      const plaintextOutput = document.getElementById('plaintext-output');
      if (copyPlaintextBtn && plaintextOutput) {
        copyPlaintextBtn.addEventListener('click', function() {
          plaintextOutput.select();
          plaintextOutput.setSelectionRange(0, 99999);
          document.execCommand('copy');
          copyPlaintextBtn.textContent = 'Copied!';
          setTimeout(() => { copyPlaintextBtn.textContent = 'Copy Text'; }, 1200);
        });
      }

      const markdownTabBtn = document.getElementById('markdownTabBtn');
      const plaintextTabBtn = document.getElementById('plaintextTabBtn');
      const markdownTab = document.getElementById('markdownTab');
      const plaintextTab = document.getElementById('plaintextTab');

      function activateTab(tab) {
        if (tab === 'markdown') {
          markdownTabBtn.classList.add('active');
          plaintextTabBtn.classList.remove('active');
          markdownTab.classList.add('active');
          plaintextTab.classList.remove('active');
        } else if (tab === 'plaintext') {
          markdownTabBtn.classList.remove('active');
          plaintextTabBtn.classList.add('active');
          markdownTab.classList.remove('active');
          plaintextTab.classList.add('active');
        }
      }

      markdownTabBtn.addEventListener('click', () => activateTab('markdown'));
      plaintextTabBtn.addEventListener('click', () => activateTab('plaintext'));

      // Markdown preview toggle logic
      const previewMarkdownBtn = document.getElementById('previewMarkdownBtn');
      let isMarkdownPreviewing = false;

      function updateMarkdownPreview() {
        if (isMarkdownPreviewing) {
          // Show rendered markdown, hide textarea
          markdownOutput.style.display = 'none';
          renderedMarkdown.style.display = '';
          previewMarkdownBtn.classList.add('active');
          // Render markdown
          renderedMarkdown.innerHTML = marked.parse(markdownOutput.value, { gfm: true, breaks: true });
        } else {
          // Show textarea, hide rendered markdown
          markdownOutput.style.display = '';
          renderedMarkdown.style.display = 'none';
          previewMarkdownBtn.classList.remove('active');
        }
      }

      if (previewMarkdownBtn) {
        previewMarkdownBtn.addEventListener('click', function() {
          isMarkdownPreviewing = !isMarkdownPreviewing;
          updateMarkdownPreview();
        });
      }

      // Initialize preview state on load
      updateMarkdownPreview();
    });
  </script>
</body>
</html>